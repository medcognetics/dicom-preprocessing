version: 2.1

jobs:
    build:
        docker:
            - image: rust:latest
        steps:
            - checkout
            - restore_cache:
                key: project-cache
            - run:
                name: Install dependencies
                command: rustup component add rustfmt
            - run:
                name: Check formatting
                command: cargo fmt -- --check
            - run:
                name: Stable Build
                command: cargo build
            - run:
                name: Test
                command: cargo test
            - save_cache:
                key: project-cache
                paths:
                - "~/.cargo"
                - "./target"

    test_python:
        docker:
            - image: cimg/python:3.11-node
        steps:
            - checkout
            - restore_cache:
                keys:
                  - v1-dependencies-{{ checksum "pdm.lock" }}
            - run:
                name: Install dependencies
                command: make init
            - save_cache:
                paths:
                  - ~/.cache/pip
                  - ~/.cache/pdm
                key: v1-dependencies-{{ checksum "pdm.lock" }}
            - run:
                name: Run tests
                command: make test-python

workflows:
    build_and_test:
        jobs:
            - test_python
            - build
